<% layout('layouts/boilerplate') %>

    <main class="main-content">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="form-container">
                        <h2 class="form-title">Welcome Back</h2>

                        <form method="POST" action="/signup" id="signupForm" class="needs-validation" novalidate>
                            <!-- Username -->
                            <div class="form-group">
                                <label class="form-label">Username</label>
                                <input type="text" name="username" id="username" class="form-control"
                                    placeholder="Enter your username" required>
                                <div class="invalid-feedback">Please provide a valid Username.</div>
                            </div>

                            <!-- Email -->
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" name="email" id="email" class="form-control"
                                    placeholder="Enter your email" required>
                                <div class="invalid-feedback">Please provide a valid email.</div>
                            </div>

                            <!-- User Role -->
                            <div class="form-group">
                                <label class="form-label" for="userRole">Select Categories:</label>
                                <select class="form-control role-dropdown" name="userRole" id="userRole" required>
                                    <option value="">-- Select a role --</option>
                                    <option value="citizen">Citizen</option>
                                    <option value="volunteer">Volunteer</option>
                                    <option value="coastal residence">Coastal Residence</option>
                                    <option value="disaster manager">Disaster Manager</option>
                                    <option value="admin">Admin</option>
                                </select>
                                <div class="invalid-feedback">Please select a role</div>
                            </div>

                            <!-- Aadhaar + OTP -->
                            <div class="form-group">
                                <label class="form-label">Aadhar Card</label>
                                <div class="d-flex align-items-center">
                                    <input type="text" id="aadharInput" name="aadharNum" class="form-control me-2"
                                        placeholder="xxxx-xxxx-xxxx" required>
                                    <button type="button" id="sendOtpBtn" class="btn btn-primary-custom">Send
                                        OTP</button>
                                </div>

                                <div id="aadharError" class="invalid-feedback">Please provide a valid Aadhaar number.
                                </div>

                                <!-- Display generated OTP here -->
                                <div id="otpDisplay" class="mt-2" style="color: #fff; font-weight: 600; display:none;">
                                </div>
                            </div>

                            <!-- OTP Input -->
                            <div class="form-group" id="otpGroup" style="display:none;">
                                <label class="form-label">Enter OTP</label>
                                <input type="text" id="otpInput" class="form-control" placeholder="Enter OTP">
                                <div id="otpError" class="invalid-feedback">Invalid OTP. Please try again.</div>
                                <button type="button" id="verifyOtpBtn" class="btn btn-primary-custom mt-2">Verify
                                    OTP</button>
                            </div>

                            <!-- Phone -->
                            <div class="form-group">
                                <label class="form-label">Phone No.</label>
                                <input type="text" name="phoneNum" id="phoneNum" class="form-control"
                                    placeholder="+91 xxxxxxxxxx" required>
                                <div class="invalid-feedback">Please provide a valid phone number.</div>
                            </div>

                            <!-- Password -->
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" name="password" id="password" class="form-control"
                                    placeholder="••••••••" required minlength="8">
                                <div class="invalid-feedback">Please provide a valid password.</div>
                            </div>

                            <button type="submit" id="submitBtn" class="btn btn-primary-custom">Sign up</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let generatedOtp = "";

            const aadharInput = document.getElementById("aadharInput");
            const sendOtpBtn = document.getElementById("sendOtpBtn");
            const otpGroup = document.getElementById("otpGroup");
            const otpInput = document.getElementById("otpInput");
            const verifyOtpBtn = document.getElementById("verifyOtpBtn");
            const otpErrorDiv = document.getElementById("otpError");
            const otpDisplay = document.getElementById("otpDisplay");
            const submitBtn = document.getElementById("submitBtn");
            const aadharError = document.getElementById("aadharError");
            const signupForm = document.getElementById("signupForm");

            // Disable submit initially
            submitBtn.disabled = true;

            // Send OTP
            sendOtpBtn.addEventListener("click", function () {
                const aadhar = aadharInput.value.trim();

                if (!/^\d{12}$/.test(aadhar)) {
                    aadharError.style.display = "block";
                    aadharError.textContent = "Aadhaar must be 12 digits";
                    otpDisplay.style.display = "none";
                    return;
                } else {
                    aadharError.style.display = "none";
                }

                // Generate OTP
                generatedOtp = Math.floor(100000 + Math.random() * 900000).toString();

                // Show OTP below Aadhaar field
                otpDisplay.textContent = `Your OTP is: ${generatedOtp}`;
                otpDisplay.style.display = "block";

                // Show OTP input section
                otpGroup.style.display = "block";
            });

            // Verify OTP
            verifyOtpBtn.addEventListener("click", function () {
                const enteredOtp = otpInput.value.trim();

                if (enteredOtp === generatedOtp) {
                    otpErrorDiv.style.display = "none";
                    alert("OTP verified! You can now submit the form.");
                    submitBtn.disabled = false;
                } else {
                    otpErrorDiv.style.display = "block";
                    otpErrorDiv.textContent = "Invalid OTP. Please try again.";
                    submitBtn.disabled = true;
                }
            });

            // Only allow digits in OTP
            otpInput.addEventListener("input", function (e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });

            // Prevent form submit if OTP not verified
            signupForm.addEventListener("submit", function (e) {
                if (submitBtn.disabled) {
                    e.preventDefault();
                    alert("Please verify OTP before submitting.");
                }
            });
        });
    </script>